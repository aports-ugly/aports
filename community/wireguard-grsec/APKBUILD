# Contributor: Johannes Matheis <jomat+alpinebuild@jmt.gr>
# Maintainer: Johannes Matheis <jomat+alpinebuild@jmt.gr>
pkgname=wireguard
pkgver=volatile
gitcommit=99b49aef8fdd8de5009682fbee88450bcf77aa98
pkgrel=3
pkgdesc="WireGuard is an extremely simple yet fast and modern VPN that utilizes state-of-the-art cryptography"
url="https://www.wireguard.io/"
arch="all"
license="GPL"
depends=""
makedepends="linux-headers linux-grsec-dev libmnl-dev"
install=""
subpackages="$pkgname-doc"
source="https://git.zx2c4.com/WireGuard/snapshot/WireGuard-${gitcommit}.tar.xz
	wireguard.ifupdown
	README.alpine
	wg_example.conf"
builddir="$srcdir/WireGuard-${gitcommit}/src/"

getpkgver() {
	echo ${pkgrel}_git${gitcommit}
}

prepare() {
	local i
	cd "$builddir"
	for i in $source; do
		case $i in
		*.patch) msg $i; patch -p1 -i "$srcdir"/$i || return 1;;
		esac
	done
}

build() {
	cd "$builddir"
	make KCFLAGS=-fno-pie || return 1
}

package() {
	cd "$builddir"
	make DESTDIR="$pkgdir" INSTALL_MOD_PATH="$pkgdir" install || return 1
	install -D -m755 $srcdir/wireguard.ifupdown $pkgdir/etc/network/if-pre-up.d/wireguard
	install -D -m755 $srcdir/wireguard.ifupdown $pkgdir/etc/network/if-post-down.d/wireguard
	install -D -m600 $srcdir/wg_example.conf $pkgdir/usr/share/doc/wireguard/wg_example.conf
	install -D -m644 $srcdir/README.alpine $pkgdir/usr/share/doc/wireguard/README.alpine
}

md5sums="399a3f8935de699319ee37780f388212  WireGuard-99b49aef8fdd8de5009682fbee88450bcf77aa98.tar.xz
46afa79016cd06b262893b58470526f5  wireguard.ifupdown
6ab79279e10ada9fd84b718e0b4db8f9  README.alpine
b3e9f999dbaf32d063a75479e9ebbc87  wg_example.conf"
sha256sums="6fa4193c3592f9c0c3ef85c216737f5b296746d2f2a7b072c71cb67bad46332d  WireGuard-99b49aef8fdd8de5009682fbee88450bcf77aa98.tar.xz
63ee8f4da94e76ff2351d66d78237dcf62a8d6f4b8b00dad563e0742b10a3780  wireguard.ifupdown
677751d41950ed1acc2fc12d82192005ae633f1c6284d223a7a4638d96e04918  README.alpine
549c94588eb42656c6af7e84c1e4a2011f202500a95a6e520042ab6cbf32debf  wg_example.conf"
sha512sums="1cf9c15aa978c730a1c117ee9c9e4db75bd4e1cbed5908241958b089623c8487fa4543c5c5fe386a0ada276ddd9763c033dc8fdc3c1a29d9287fbd22121e9d0f  WireGuard-99b49aef8fdd8de5009682fbee88450bcf77aa98.tar.xz
0d7d63a59ef29972ca71ced27608ef6946f2846bc71e6e53c8d3b239a2180b9bc1223455654c1be11102ee657d4de396cb1e138a5be602acb9c47388f33be539  wireguard.ifupdown
e9589b9c76645786bc1f3cd37559e53e5cb839a23c7e17d48ca7f5f4b35ad5b72b20312df4d9a2ddcada42b99b31d8acd85b387623258968ad8a6878fbbe5bfc  README.alpine
9e6ce4d394d606e5d5485bd746f00de17eab42c939e9b7173ef7237003e43f4a5586634a6425fe8d3f473bf72131d60f9ed30f4dc9a65bd244b1e08a06575ce0  wg_example.conf"
