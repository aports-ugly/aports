# Contributor: stef <l0ls0fo2i@ctrlc.hu>

pkgname=libuhd
pkgver=3.14.1.1
pkgrel=0
pkgdesc="Universal Software Radio Peripheral (USRP) userspace driver"
arch='all'
url="http://www.ettus.com/kb/category/software-documentation/uhd-manual"
license='GPL'
makedepends='python3 python3-dev py3-cheetah py3-mako py3-numpy py3-requests py3-markupsafe cmake boost-python3 py3-setuptools py3-numpy-dev boost-dev eudev-dev ncurses-dev orc-dev libusb-dev doxygen chrpath'
subpackages="$pkgname-dev $pkgname-doc"

source="$pkgname-$pkgver.tar.gz::https://github.com/EttusResearch/uhd/archive/v${pkgver}.tar.gz
boost_python_ver_fix.patch"

builddir="$srcdir/uhd-$pkgver/host"

prepare() {
	default_prepare
	find -name "*.py" -or -name '*.py.in' | xargs sed -i "s|#!/usr/bin/env python$|#!/usr/bin/env python3|"
}

build() {
  cd "$builddir"
  mkdir -p build
  cd build
  # -DBoost_PYHTON3 defines are workarounds for cmake not finding boost_python37
  cmake .. -DCMAKE_INSTALL_PREFIX=/usr/ \
           -DENABLE_PYTHON_API=ON \
           -DENABLE_PYTHON3=ON \
           -DPYTHON_EXECUTABLE=/usr/bin/python3 \
           -DBoost_PYTHON3_LIBRARY=$(echo /usr/lib/libboost_python37.so*) \
			  -DBoost_PYTHON3_FOUND=1 \
           -DENABLE_UTILS=ON \
           -DENABLE_TESTS=OFF \
           -DENABLE_E100=ON \
           -DENABLE_E300=ON \
           -Wno-dev
  make
}

package() {
	cd "$builddir/build"
	make DESTDIR="$pkgdir" install
   install -Dm644 "../utils/uhd-usrp.rules" "$pkgdir/usr/lib/udev/rules.d/10-uhd-usrp.rules"

	cd "$pkgdir"/$_prefix

	# Remove RPATHs.
	chrpath -d "$pkgdir"/usr/lib/python3.7/site-packages/uhd/libpyuhd.so

}
sha512sums="461f9314dd0af5feed91b18196cccb7828cee91a712dec0bb8b59878d54500906beea9f6dd938a90eae041dca6a1f6b564b6924d8e53e4b2fb507f2ed7be0ff4  libuhd-3.14.1.1.tar.gz
558dd49fbdef27b28a933d4c26137a40c1f1ad1bcb9458dca2957ae7dbd770fa6b80c1ecae441dcad4a4cb038e3f830b07b8292ee758ddd6b1a9bcc7661474fd  boost_python_ver_fix.patch"
